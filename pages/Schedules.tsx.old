import { useState, useEffect } from 'react';
import { useAuth } from '@/components/auth/AuthProvider';
import { getMySchedules } from '@/db/api';
import type { Schedule } from '@/types/types';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { ChevronLeft, ChevronRight, Calendar, Clock, Info } from 'lucide-react';
import { toast } from 'sonner';
import { format, startOfWeek, endOfWeek, addWeeks, subWeeks, isSameDay, parseISO, addDays } from 'date-fns';

export default function Schedules() {
  const { user } = useAuth();
  const [schedules, setSchedules] = useState<Schedule[]>([]);
  const [loading, setLoading] = useState(true);
  const [currentWeekStart, setCurrentWeekStart] = useState(startOfWeek(new Date(), { weekStartsOn: 1 }));

  const weekEnd = endOfWeek(currentWeekStart, { weekStartsOn: 1 });

  useEffect(() => {
    if (user) {
      loadSchedules();
    }
  }, [user, currentWeekStart]);

  const loadSchedules = async () => {
    if (!user) return;

    try {
      setLoading(true);
      const startDate = format(currentWeekStart, 'yyyy-MM-dd');
      const endDate = format(weekEnd, 'yyyy-MM-dd');
      const data = await getMySchedules(user.id, startDate, endDate);
      setSchedules(data);
    } catch (error) {
      console.error('Error loading schedules:', error);
      toast.error('Failed to load schedules');
    } finally {
      setLoading(false);
    }
  };

  const goToPreviousWeek = () => {
    setCurrentWeekStart(subWeeks(currentWeekStart, 1));
  };

  const goToNextWeek = () => {
    setCurrentWeekStart(addWeeks(currentWeekStart, 1));
  };

  const goToThisWeek = () => {
    setCurrentWeekStart(startOfWeek(new Date(), { weekStartsOn: 1 }));
  };

  const getScheduleForDate = (date: Date): Schedule | undefined => {
    const dateStr = format(date, 'yyyy-MM-dd');
    return schedules.find(s => s.shift_date === dateStr);
  };

  const calculateShiftDuration = (startTime: string, endTime: string): string => {
    const [startHours, startMinutes] = startTime.split(':').map(Number);
    const [endHours, endMinutes] = endTime.split(':').map(Number);
    
    let hours = endHours - startHours;
    let minutes = endMinutes - startMinutes;
    
    if (minutes < 0) {
      hours -= 1;
      minutes += 60;
    }
    
    if (hours < 0) {
      hours += 24;
    }
    
    return `${hours}h${minutes > 0 ? ` ${minutes}m` : ''}`;
  };

  const weekDays = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i));
  const today = new Date();

  const isCurrentWeek = isSameDay(currentWeekStart, startOfWeek(new Date(), { weekStartsOn: 1 }));

  return (
    <div className="min-h-screen p-6 xl:p-8">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="space-y-2">
          <h1 className="text-4xl font-bold gradient-text">My Shifts</h1>
          <p className="text-muted-foreground">View your weekly work schedule</p>
        </div>

        {/* Info Banner */}
        <Alert className="border-accent/20 bg-accent/5">
          <Info className="h-4 w-4 text-accent" />
          <AlertDescription className="text-sm">
            All shifts are 9 hours long. If you notice any issue in your schedule, please contact your Team Leader.
          </AlertDescription>
        </Alert>

        {/* Week Navigation */}
        <Card className="glass-card">
          <CardHeader>
            <div className="flex items-center justify-between">
              <div className="space-y-1">
                <CardTitle className="flex items-center gap-2">
                  <Calendar className="h-5 w-5 text-accent" />
                  Week of {format(currentWeekStart, 'MMM d, yyyy')}
                </CardTitle>
                <CardDescription>
                  {format(currentWeekStart, 'MMM d')} - {format(weekEnd, 'MMM d, yyyy')}
                </CardDescription>
              </div>
              <div className="flex items-center gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={goToPreviousWeek}
                  className="hover:bg-accent/10"
                >
                  <ChevronLeft className="h-4 w-4" />
                </Button>
                {!isCurrentWeek && (
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={goToThisWeek}
                    className="hover:bg-accent/10"
                  >
                    This Week
                  </Button>
                )}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={goToNextWeek}
                  className="hover:bg-accent/10"
                >
                  <ChevronRight className="h-4 w-4" />
                </Button>
              </div>
            </div>
          </CardHeader>

          <CardContent>
            {loading ? (
              <div className="flex items-center justify-center py-12">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
              </div>
            ) : (
              <>
                {/* Week Timeline View */}
                <div className="grid grid-cols-1 md:grid-cols-7 gap-3 mb-8">
                  {weekDays.map((date, index) => {
                    const schedule = getScheduleForDate(date);
                    const isToday = isSameDay(date, today);

                    return (
                      <div
                        key={index}
                        className={`p-4 rounded-lg border-2 transition-all ${
                          isToday
                            ? 'border-accent bg-accent/5 shadow-glow'
                            : 'border-border bg-card/50'
                        }`}
                      >
                        <div className="text-center space-y-2">
                          <div className="font-semibold text-sm text-muted-foreground">
                            {format(date, 'EEE')}
                          </div>
                          <div className={`text-2xl font-bold ${isToday ? 'text-accent' : ''}`}>
                            {format(date, 'd')}
                          </div>
                          
                          {schedule ? (
                            schedule.status === 'working' ? (
                              <div className="space-y-2">
                                <Badge className="w-full bg-accent/20 text-accent hover:bg-accent/30">
                                  Working
                                </Badge>
                                <div className="text-xs space-y-1">
                                  <div className="flex items-center justify-center gap-1 text-muted-foreground">
                                    <Clock className="h-3 w-3" />
                                    {schedule.start_time.slice(0, 5)}
                                  </div>
                                  <div className="text-muted-foreground">
                                    {calculateShiftDuration(schedule.start_time, schedule.end_time)}
                                  </div>
                                </div>
                              </div>
                            ) : (
                              <Badge variant="secondary" className="w-full">
                                Off Day
                              </Badge>
                            )
                          ) : (
                            <Badge variant="outline" className="w-full text-muted-foreground">
                              Not Scheduled
                            </Badge>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Detailed List View */}
                <div className="space-y-2">
                  <h3 className="text-lg font-semibold mb-4">Detailed Schedule</h3>
                  <div className="rounded-lg border overflow-hidden">
                    <table className="w-full">
                      <thead className="bg-muted/50">
                        <tr>
                          <th className="text-left p-3 font-semibold">Date</th>
                          <th className="text-left p-3 font-semibold">Day</th>
                          <th className="text-left p-3 font-semibold">Shift Time</th>
                          <th className="text-left p-3 font-semibold">Status</th>
                          <th className="text-left p-3 font-semibold">Notes</th>
                        </tr>
                      </thead>
                      <tbody>
                        {weekDays.map((date, index) => {
                          const schedule = getScheduleForDate(date);
                          const isToday = isSameDay(date, today);

                          return (
                            <tr
                              key={index}
                              className={`border-t transition-colors ${
                                isToday ? 'bg-accent/5' : 'hover:bg-muted/30'
                              }`}
                            >
                              <td className="p-3">
                                <div className="font-medium">
                                  {format(date, 'MMM d, yyyy')}
                                </div>
                              </td>
                              <td className="p-3">
                                <div className={isToday ? 'text-accent font-semibold' : ''}>
                                  {format(date, 'EEEE')}
                                </div>
                              </td>
                              <td className="p-3">
                                {schedule && schedule.status === 'working' ? (
                                  <div className="flex items-center gap-2">
                                    <Clock className="h-4 w-4 text-muted-foreground" />
                                    <span>
                                      {schedule.start_time.slice(0, 5)} – {schedule.end_time.slice(0, 5)}
                                    </span>
                                    <span className="text-xs text-muted-foreground">
                                      ({calculateShiftDuration(schedule.start_time, schedule.end_time)})
                                    </span>
                                  </div>
                                ) : (
                                  <span className="text-muted-foreground">—</span>
                                )}
                              </td>
                              <td className="p-3">
                                {schedule ? (
                                  schedule.status === 'working' ? (
                                    <Badge className="bg-accent/20 text-accent hover:bg-accent/30">
                                      Working
                                    </Badge>
                                  ) : (
                                    <Badge variant="secondary">Off Day</Badge>
                                  )
                                ) : (
                                  <Badge variant="outline" className="text-muted-foreground">
                                    Not Scheduled
                                  </Badge>
                                )}
                              </td>
                              <td className="p-3">
                                <span className="text-sm text-muted-foreground">
                                  {schedule?.notes || '—'}
                                </span>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
